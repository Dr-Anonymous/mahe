---
---

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Intercom</title>
    <script src="js/jquery-2.0.0.js"></script>
    <script src="js/bootstrap.js"></script>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <style>
	textarea { resize:none; }

	video {
	   width:100%;
	   max-width:500px;
	   height:auto;
	}
	</style>
</head>
<body>
<div class="span3">
  <Video id="localVideo" controls muted>
</div>
<div class="span5">
  <Video id="remoteVideo" controls>
</div>
<div id="chats" class="span4 hide">
  <fieldset class="well">
    <p class="head muted">
      Chats
    </p>
    <div class="text-info" id="chatlog" style="height:350px; overflow:auto;">
    </div>
  </fieldset>
  <form class="form-inline" onSubmit="return sendMessage()" action="">
    <input type="text" id="messageTextBox" placeholder="Type your message here">
    <button type="submit" id="sendMessageBtn" class="btn">Send message</button>
  </form>
  <input type="file" id="fileBtn">
</div>

<div class="modal" id="showLocalOffer" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" hidden>
  <div class="modal-header">
    <h3 id="myModalLabel">Your are the first one here...<!--Send your local offer to someone else--></h3>
  </div>
  <div class="modal-body">
    <!--Here's your "offer" -- it tells someone else how to connect to you.  Send the whole thing to them, for example in an instant message or e-mail.-->
	Initiating intercom. Remember intercom only works on local networks like a WIFI. Not over the internet
  <br/>
  <textarea class="input-large hide" id="localOffer" name="localOffer" rows="10" cols="100"></textarea>
  </div>
  <div class="modal-footer hide">
    <button class="btn btn-primary" id="offerSentBtn" data-dismiss="modal" aria-hidden="true">Okay, I sent it.</button>
  </div>
</div>

<div class="modal" id="showLocalAnswer" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" hidden>
  <div class="modal-header">
    <h3 id="myModalLabel">Joining a call .....<!--Send your local answer to someone else--></h3>
  </div>
  <div class="modal-body">
	Your are joining the intercom call initiated by others......
    <!--Here's your "answer" -- it tells someone else how to connect to you.  Send the whole thing to them, for example in an instant message or e-mail.-->
  <br/>
  <textarea class="input-large hide" id="localAnswer" name="localAnswer" rows="10" cols="100"></textarea>
  </div>
  <div class="modal-footer hide">
    <button class="btn btn-primary" id="answerSentBtn" data-dismiss="modal" aria-hidden="true">Okay, I sent it.</button>
  </div>
</div>

<div class="modal" id="getRemoteOffer" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" hidden>
  <div class="modal-header">
    <h3 id="myModalLabel">Joining a call...<!--Paste the "offer" you received--></h3>
  </div>
  <div class="modal-body">
    Your are joining the intercom call initiated by others......
	<!--The person who created the room will send you an "offer" string -- paste it here.-->
  <br/>
  <textarea class="input-large hide" id="remoteOffer" name="remoteOffer" rows="10" cols="100"></textarea>
  </div>
  <div class="modal-footer hide">
    <button class="btn btn-primary" id="offerRecdBtn" data-dismiss="modal" aria-hidden="true">Okay, I pasted it.</button>
  </div>
</div>

<div class="modal" id="getRemoteAnswer" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" hidden>
  <div class="modal-header">
    <h3 id="myModalLabel">Your are the first one here.<!--Paste the "answer" you received--></h3>
  </div>
  <div class="modal-body">
	Initiating intercom. Waiting for others....<br/>
	Remember intercom works best on local networks like a WIFI.
    <!--Now paste in the "answer" that was sent back to you.-->
  <br/>
  <textarea class="input-large hide" id="remoteAnswer" name="remoteAnswer" rows="10" cols="100"></textarea>
  </div>
  <div class="modal-footer hide">
    <button class="btn btn-primary" id="answerRecdBtn" data-dismiss="modal" aria-hidden="true">Okay, I pasted it.</button>
  </div>
</div>

<div class="modal" id="waitForConnection" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" hidden>
  <div class="modal-header">
    <h3 id="myModalLabel">Waiting for connection</h3>
  </div>
  <div class="modal-body">
    This dialog will disappear when a connection is made.
  </div>
  <div class="spinner" align="center">
    <img src="img/spinner.gif"></img>
  </div>
</div>

<div class="modal" id="createOrJoin" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <h3 id="myModalLabel">Creating or joining a room....</h3>
  </div>
  <div class="modal-footer hide">
    <button class="btn" id="joinBtn" data-dismiss="modal" aria-hidden="true">Join</button>
    <button class="btn btn-primary" id="createBtn" data-dismiss="modal" aria-hidden="true">Create</button>
  </div>
</div>

<script type="module">
	// Import the functions you need from the SDKs you need
	import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-app.js";
	
	// Firebase configuration
	const firebaseConfig = {
	apiKey: "AIzaSyBclMUk5tqdNWgdIOB8MRnq9m31t0QFlDQ",
	authDomain: "cam-control-a9d76.firebaseapp.com",
	databaseURL: "https://cam-control-a9d76-default-rtdb.firebaseio.com",
	projectId: "cam-control-a9d76",
	storageBucket: "cam-control-a9d76.appspot.com",
	messagingSenderId: "835440701577",
	appId: "1:835440701577:web:3ba52373edd9b2db3b9658"
	};

	// Initialize Firebase
	const app = initializeApp(firebaseConfig);
	import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-database.js";
	
	var firstTime = true;
	const db = getDatabase();
	const callerdb = ref(db, '1/');
	const receiverdb = ref(db, '2/');
	onValue(callerdb, (snapshot) => {
	  const data = snapshot.val();
	  //console.log(data);
	  window.data = data;
	  
	  if (data == null && firstTime) { $('#createBtn').click(); firstTime = false;}
	  else { if (firstTime) $('#joinBtn').click(); }
	});
	
	onValue(receiverdb, (snapshot) => {
	  const hisoffer = snapshot.val();
	  //console.log(hisoffer);
	  window.hisoffer = hisoffer;
	  if (!firstTime && hisoffer != null) { $('#answerRecdBtn').click();}
	});
	window.set = set;
	window.callerdb = callerdb;
	window.receiverdb = receiverdb;
	
	window.onunload = function(){
	set(ref(db), null);
	};
</script>

<script src="js/serverless-webrtc.js"></script>
<script src="js/file-transfer.js"></script>

</body>
</html>
